<Window x:Class="Proc.AnalysisWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:Proc"
        Title="Proc - Activity Analysis"
        Width="900" Height="600"
        MinWidth="700" MinHeight="400"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="{DynamicResource ThemeBg}"
        WindowStartupLocation="CenterScreen"
        Icon="/Proc.ico"
        KeyDown="Window_KeyDown">

    <Window.Resources>
        <local:InverseBoolToVisibilityConverter x:Key="InverseBoolToVis"/>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>

        <Style x:Key="LabelText" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource ThemeSubText}"/>
            <Setter Property="FontFamily" Value="Consolas"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="ValueText" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource ThemeText}"/>
            <Setter Property="FontFamily" Value="Consolas"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="HeaderText" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource ThemeAccent}"/>
            <Setter Property="FontFamily" Value="Consolas"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>

        <Style x:Key="NavButton" TargetType="Button">
            <Setter Property="Background" Value="{DynamicResource ThemeBorder}"/>
            <Setter Property="Foreground" Value="{DynamicResource ThemeText}"/>
            <Setter Property="FontFamily" Value="Consolas"/>
            <Setter Property="BorderBrush" Value="{DynamicResource ThemeCheckBorder}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="3" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource ThemeHover}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource ThemePressed}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="PeriodButton" TargetType="RadioButton">
            <Setter Property="Foreground" Value="{DynamicResource ThemeSubText}"/>
            <Setter Property="FontFamily" Value="Consolas"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="Bd" Background="Transparent"
                                BorderBrush="Transparent" BorderThickness="0,0,0,2"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{DynamicResource ThemeAccent}"/>
                                <Setter Property="Foreground" Value="{DynamicResource ThemeAccent}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource ThemeSurfaceAlt}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <DockPanel>
        <!-- Custom title bar -->
        <Border DockPanel.Dock="Top" Background="{DynamicResource ThemeSurface}" Padding="12,6"
                BorderBrush="{DynamicResource ThemeBorder}" BorderThickness="0,0,0,1"
                MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
            <DockPanel>
                <Button DockPanel.Dock="Right" Content="&#xD7;" FontSize="18"
                        Background="Transparent" Foreground="{DynamicResource ThemeSubText}"
                        BorderThickness="0" Cursor="Hand" Padding="8,0"
                        Click="CloseButton_Click" VerticalAlignment="Center"/>
                <TextBlock Text="Proc - Activity Analysis" FontFamily="Consolas" FontSize="13"
                           Foreground="{DynamicResource ThemeText}" VerticalAlignment="Center"/>
            </DockPanel>
        </Border>

        <!-- Top control bar -->
        <Border DockPanel.Dock="Top" Background="{DynamicResource ThemeSurface}" Padding="12,8"
                BorderBrush="{DynamicResource ThemeBorder}" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Period selector (left) -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                    <RadioButton x:Name="DayRadio" Content="Day" GroupName="Period"
                                 Style="{StaticResource PeriodButton}" IsChecked="True"
                                 Checked="Period_Checked"/>
                    <RadioButton x:Name="WeekRadio" Content="Week" GroupName="Period"
                                 Style="{StaticResource PeriodButton}"
                                 Checked="Period_Checked"/>
                    <RadioButton x:Name="MonthRadio" Content="Month" GroupName="Period"
                                 Style="{StaticResource PeriodButton}"
                                 Checked="Period_Checked"/>
                </StackPanel>

                <!-- Date navigation (center) -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Button Content="&#x25C0;" Style="{StaticResource NavButton}"
                            Click="PrevPeriod_Click" Margin="0,0,8,0" FontSize="10"/>
                    <Button x:Name="PeriodButton" Content="{Binding PeriodLabel}" Style="{StaticResource NavButton}"
                            Click="PeriodLabel_Click" MinWidth="200" FontSize="13"/>
                    <Button Content="&#x25B6;" Style="{StaticResource NavButton}"
                            Click="NextPeriod_Click" Margin="8,0,0,0" FontSize="10"/>
                    <Popup x:Name="CalendarPopup" StaysOpen="False"
                           PlacementTarget="{Binding ElementName=PeriodButton}"
                           Placement="Bottom" AllowsTransparency="True">
                        <Border Background="{DynamicResource ThemeSurface}"
                                BorderBrush="{DynamicResource ThemeCheckBorder}" BorderThickness="1"
                                CornerRadius="4" Padding="4">
                            <StackPanel>
                                <Calendar x:Name="DateCalendar"
                                          SelectedDatesChanged="DateCalendar_SelectedDatesChanged"/>
                                <Button Content="Today" Style="{StaticResource NavButton}"
                                        Click="CalendarToday_Click" HorizontalAlignment="Stretch"
                                        Margin="4,2,4,2"/>
                            </StackPanel>
                        </Border>
                    </Popup>
                </StackPanel>

                <!-- Summary stats (right) -->
                <StackPanel Grid.Column="2" Orientation="Horizontal"
                            HorizontalAlignment="Right" VerticalAlignment="Center">
                    <TextBlock Text="{Binding TotalTimeText}" Style="{StaticResource ValueText}"
                               Margin="12,0"/>
                    <TextBlock Text="{Binding TopAppText}" Style="{StaticResource LabelText}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Timeline (Day view only) -->
        <Border DockPanel.Dock="Top" Background="{DynamicResource ThemeSurfaceAlt}" Padding="12,8,12,4"
                BorderBrush="{DynamicResource ThemeBorder}" BorderThickness="0,0,0,1"
                Visibility="{Binding IsDayView, Converter={StaticResource BoolToVis}}">
            <DockPanel>
                <TextBlock DockPanel.Dock="Top" Text="Timeline"
                           Style="{StaticResource HeaderText}" Margin="0,0,0,4" FontSize="12"/>
                <Grid Height="36">
                    <!-- Hour labels -->
                    <Canvas x:Name="TimelineHourLabels" Height="12" VerticalAlignment="Bottom"/>
                    <!-- Activity blocks -->
                    <Canvas x:Name="TimelineCanvas" Height="22" VerticalAlignment="Top"
                            Background="{DynamicResource ThemeSurfaceAlt}" ClipToBounds="True"
                            SizeChanged="TimelineCanvas_SizeChanged"/>
                </Grid>
            </DockPanel>
        </Border>

        <!-- Main content -->
        <Grid Margin="12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*" MinWidth="350"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="2*" MinWidth="200"/>
            </Grid.ColumnDefinitions>

            <!-- Left: App usage bars -->
            <DockPanel Grid.Column="0">
                <DockPanel DockPanel.Dock="Top" Margin="0,0,0,8">
                    <TextBlock Text="Application Usage"
                               Style="{StaticResource HeaderText}"/>
                    <Border x:Name="AllButton" DockPanel.Dock="Right" HorizontalAlignment="Right"
                            Padding="10,3" CornerRadius="3" Cursor="Hand"
                            Background="{DynamicResource ThemeSurfaceAlt}"
                            BorderBrush="{DynamicResource ThemeCheckBorder}" BorderThickness="1"
                            MouseLeftButtonDown="AllButton_Click">
                        <TextBlock Text="All" FontFamily="Consolas" FontSize="12"
                                   Foreground="{DynamicResource ThemeSubText}"/>
                    </Border>
                </DockPanel>

                <!-- No data placeholder -->
                <TextBlock Text="No activity data for this period"
                           Style="{StaticResource LabelText}" HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Visibility="{Binding HasData, Converter={StaticResource InverseBoolToVis}}"/>

                <ScrollViewer VerticalScrollBarVisibility="Auto"
                              Visibility="{Binding HasData, Converter={StaticResource BoolToVis}}">
                    <ItemsControl ItemsSource="{Binding AppBars}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border x:Name="BarRow" Padding="6,4" Cursor="Hand"
                                        Background="Transparent" CornerRadius="3"
                                        MouseLeftButtonDown="AppBar_Click" Margin="0,1">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="20"/>
                                            <ColumnDefinition Width="130"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Icon -->
                                        <Image Grid.Column="0" Source="{Binding Icon}" Width="16" Height="16"
                                               VerticalAlignment="Center"
                                               RenderOptions.BitmapScalingMode="HighQuality"/>

                                        <!-- Process name -->
                                        <TextBlock Grid.Column="1" Text="{Binding ProcessName}"
                                                   Foreground="{DynamicResource ThemeText}" FontFamily="Consolas" FontSize="12"
                                                   VerticalAlignment="Center" Margin="4,0,8,0"
                                                   TextTrimming="CharacterEllipsis"/>

                                        <!-- Bar -->
                                        <Grid Grid.Column="2" Height="16" VerticalAlignment="Center" Margin="0,0,8,0">
                                            <Border CornerRadius="2" Background="{DynamicResource ThemeSurfaceAlt}"/>
                                            <Border CornerRadius="2" Background="{Binding BarBrush}"
                                                    HorizontalAlignment="Stretch"
                                                    RenderTransformOrigin="0,0.5">
                                                <Border.RenderTransform>
                                                    <ScaleTransform ScaleX="{Binding BarWidthRatio}"/>
                                                </Border.RenderTransform>
                                            </Border>
                                        </Grid>

                                        <!-- Time + Percent -->
                                        <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding TimeText}" Foreground="{DynamicResource ThemeText}"
                                                       FontFamily="Consolas" FontSize="12" MinWidth="50"
                                                       TextAlignment="Right"/>
                                            <TextBlock Text="{Binding PercentText}" Foreground="{DynamicResource ThemeDimText}"
                                                       FontFamily="Consolas" FontSize="11" Margin="6,0,0,0"
                                                       MinWidth="40"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                                <DataTemplate.Triggers>
                                    <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                        <Setter TargetName="BarRow" Property="Background" Value="{DynamicResource ThemeSurfaceAlt}"/>
                                    </DataTrigger>
                                    <Trigger SourceName="BarRow" Property="IsMouseOver" Value="True">
                                        <Setter TargetName="BarRow" Property="Background" Value="{DynamicResource ThemeBorder}"/>
                                    </Trigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </DockPanel>

            <!-- GridSplitter -->
            <GridSplitter Grid.Column="1" Width="4" Margin="4,0"
                          HorizontalAlignment="Center" VerticalAlignment="Stretch"
                          Background="{DynamicResource ThemeBorder}"/>

            <!-- Right: Detail panel -->
            <DockPanel Grid.Column="2">
                <TextBlock DockPanel.Dock="Top" Text="{Binding DetailHeader}"
                           Style="{StaticResource HeaderText}" Margin="0,0,0,8"
                           TextTrimming="CharacterEllipsis"/>

                <TextBlock Text="Select an application to view details"
                           Style="{StaticResource LabelText}" HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Visibility="{Binding HasDetail, Converter={StaticResource InverseBoolToVis}}"/>

                <ScrollViewer VerticalScrollBarVisibility="Auto"
                              Visibility="{Binding HasDetail, Converter={StaticResource BoolToVis}}">
                    <ItemsControl ItemsSource="{Binding DetailItems}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <DockPanel x:Name="DetailRow" Margin="0,2">
                                    <TextBlock x:Name="ValueText" DockPanel.Dock="Right"
                                               Text="{Binding Value}"
                                               Foreground="{DynamicResource ThemeText}" FontFamily="Consolas" FontSize="12"
                                               VerticalAlignment="Center" Margin="8,0,0,0"/>
                                    <TextBlock x:Name="LabelText" Text="{Binding Label}"
                                               TextTrimming="CharacterEllipsis"
                                               Foreground="{DynamicResource ThemeSubText}" FontFamily="Consolas" FontSize="12"
                                               VerticalAlignment="Center"/>
                                </DockPanel>
                                <DataTemplate.Triggers>
                                    <DataTrigger Binding="{Binding IsHeader}" Value="True">
                                        <Setter TargetName="LabelText" Property="Foreground" Value="{DynamicResource ThemeAccent}"/>
                                        <Setter TargetName="LabelText" Property="FontWeight" Value="Bold"/>
                                        <Setter TargetName="DetailRow" Property="Margin" Value="0,10,0,4"/>
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </DockPanel>
        </Grid>
    </DockPanel>
</Window>
